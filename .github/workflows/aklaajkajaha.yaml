name: Render Dynamic Canvas

permissions:
  contents: write

on:
  schedule:
    - cron: "*/2 * * * *"
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: "18"

    - name: Install Puppeteer
      run: npm install puppeteer

    - name: Render screenshot
      run: |
        node << 'EOF'
        const puppeteer = require('puppeteer');

        (async () => {
          const url = "https://gafsdoy85.github.io/test/index.html?username=switlydev&theme=radical&mode=general";

          const browser = await puppeteer.launch({
            headless: "new",
            args: ["--no-sandbox", "--disable-setuid-sandbox"]
          });

          const page = await browser.newPage();
          await page.setViewport({ width: 495, height: 195 });

          await page.goto(url, { waitUntil: "networkidle0" });

          // yerine bu:
          await new Promise(r => setTimeout(r, 1500));

          await page.screenshot({
            path: "dynamic.png"
          });

          await browser.close();
        })();
        EOF

    - name: Commit and push
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add dynamic.png
        git commit -m "Render dynamic image" || echo "No changes"
        git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
